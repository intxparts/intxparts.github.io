<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Old Jim's Notes</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="notes">Notes</h1>
<hr />
<h3 id="github-actions">Github Actions</h3>
<p><em>2020.01.28</em></p>
<p>Recently noticed Github added Actions for CI/CD tied directly to repositories. Setup my <a href="https://github.com/intxparts/LuaModules">LuaModules</a> repository to run tests when pushing a branch. Thankfully Leafo, an active member of the Lua community and creator of Lapis, had already created a <a href="https://github.com/leafo/gh-actions-lua">custom Github Action</a> to download and build Lua/Luajit with the desired versions. So the only work on my part was tying in my own Lua test framework into the system.</p>
<p>To run the full set of tests for the repo, it is a simple command line call to Lua.</p>
<pre><code>    [&gt; lua test_runner.lua -d ../tests
</code></pre>
<p>Due to the way I have structured the repo, this command assumes you are working in the 'src' folder. This became an issue when tying in the CI. It was a simple fix to modify the LUA_PATH environment variable so that the Lua modules could be found when not in the same directory.</p>
<pre><code>    [&gt; export LUA_PATH=./src/?.lua
    [&gt; printenv
    [&gt; ...
    [&gt; LUA_PATH=./src/?.lua
    [&gt; ...
</code></pre>
<p>Thankfully Github provides the ability to set environment variables in the container configuration section of the *.yml file.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode yml"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build</span></span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="at">    </span><span class="fu">on</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">push</span><span class="kw">]</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="at">    </span><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="at">      </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="at">        </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="at">          </span><span class="fu">LUA_PATH</span><span class="kw">:</span><span class="at"> ./src/?.lua</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="at">    ...</span></span></code></pre></div>
<p>One last problem to solve was ensuring that the test action would fail when a test failed. This was also a simple fix, in 'test_runner.lua':</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode Lua"><code class="sourceCode lua"><span id="cb4-1"><a href="#cb4-1"></a>    <span class="cf">if</span> has_errors <span class="cf">then</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>        <span class="fu">os.exit</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="cf">end</span></span></code></pre></div>
<p>By setting the exit code to non-zero, the CI picks this up and fails appropriately. At first I had tried to write to stderr, but the CI does not observe ouput to stderr as a failure.</p>
<p>Hence we land on the final CI config:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yml"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build</span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="at">    </span><span class="fu">on</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">push</span><span class="kw">]</span></span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="at">    </span><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="at">      </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="at">        </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="at">        </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="at">          </span><span class="fu">LUA_PATH</span><span class="kw">:</span><span class="at"> ./src/?.lua</span></span>
<span id="cb5-10"><a href="#cb5-10"></a></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="at">        </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v1</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> leafo/gh-actions-lua@v5</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="at">          </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="at">            </span><span class="fu">luaVersion</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;5.3&quot;</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run tests</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="at">          </span><span class="fu">run</span><span class="kw">:</span><span class="at"> lua ./src/test_runner.lua -d ./tests -et efail</span></span></code></pre></div>
<p>Note: the -et efail in the 'Run tests' action means 'exclude tests' marked with tags 'efail' (expected fail).</p>
<p>While I do appreciate and like how easy it was to use Leafos custom action for downloading and building Lua/Luajit, it is a bit slow. There are some alternatives that would make it much faster:</p>
<ul>
<li>add Lua binaries directly to the repo</li>
<li>create a git submodule and link to a repo containing the Lua binaries</li>
</ul>
<p>Unfortunately Github Actions does not ship with an 'intialize git submodules' action at the time of writing this, but the community has several solutions for this. If possible I would like to avoid using external Github Actions if I can, just for simplicity and also for the control over the CI process. It is harder to optimize when you do not have control over parts of your system.</p>
<p>One thing that I was really happy to see is that you can run CI for any OS, it just comes at a cost. Free accounts get 2,000 minutes of Github Actions running per month free. There is a multiplier if you want to use something other than Linux.</p>
<p>Minute Multiplier Linux: 1 Windows: 2 MacOS: 10</p>
<p>Cool software, I really enjoyed setting this up. It took me sometime to figure out this much (an hour or so), but that was mostly digging through Githubs documentation.</p>
<hr />
<h3 id="c-cross-platform-casting">C++ Cross Platform Casting</h3>
<p><em>2019.06.04</em></p>
<p>Stumbled across this at work when the Linux build failed to compile:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode C++"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1"></a></span>
<span id="cb6-2"><a href="#cb6-2"></a>    <span class="dt">unsigned</span> <span class="dt">char</span> c = <span class="ch">&#39;0&#39;</span>;</span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="cf">if</span> (c == <span class="dt">unsigned</span> <span class="dt">char</span>(<span class="dv">1</span>))</span>
<span id="cb6-5"><a href="#cb6-5"></a>    {</span>
<span id="cb6-6"><a href="#cb6-6"></a>        </span>
<span id="cb6-7"><a href="#cb6-7"></a>    }</span></code></pre></div>
<p>Compilation results:</p>
<ul>
<li>GCC: fail</li>
<li>Clang: fail</li>
<li>MSVC: success</li>
</ul>
<p>I think it is a bit odd that MSVC permits this, but I could just be used to the style of putting the type you are casting to in parentheses.</p>
<hr />
<h3 id="building-srlua-on-windows">Building srlua on Windows</h3>
<p><em>2017.09.19</em></p>
<p><a href="https://github.com/LuaDist/srlua">srlua</a> is a useful tool for turning lua scripts into standalone executables. Like most Lua projects srlua is more Linux focused in terms of its standard build environment. As a result Cygwin is the usual recommendation for building on Windows. I've had a variety of issues using Cygwin to build cross platform applications in the past, particularly command line applications, so I wanted to make a build script to build natively on Windows.</p>
<p>My current machine contains a typical Visual Studio 2015 community edition installation with the standard C++ libraries installed. Before starting, ensure you have also downloaded the matching version of Lua's source code and have built the luax.x.lib. If you're not sure how to do this I have created a gist <a href="https://gist.github.com/intxparts/847cdd4de54d0ea52bd9d272dead915e">here</a> which was adapted from another person's <a href="https://pastebin.com/HjVjFNwK">build script</a> for Lua on Windows.</p>
<p>To build srlua:</p>
<ul>
<li><p>download the latest <a href="https://github.com/LuaDist/srlua/releases">source code</a></p></li>
<li><p>open up the "Developer Command Prompt for 2015"</p></li>
<li><p>edit the script below inserting your respective paths to the Lua source/libs and the Windows libs</p></li>
<li><p>run the script</p>
<pre><code>  -- Build.bat -- 

  cl /MD /O2 /c /I &lt;path_to_lua_root&gt;\src *.c
  link /OUT:glue.exe glue.obj &lt;path_to_lua_libs&gt;\lua5.3.lib
  link /OUT:srlua.exe srlua.obj &quot;&lt;path_to_lua_libs&gt;\lua5.3.lib&quot; &quot;&lt;path_to_windows_kit_libs&gt;\user32.lib&quot;
</code></pre></li>
</ul>
<p><strong>path_to_windows_kit_libs</strong> was the following for my machine, running Windows 10, so you should likely have something similar.</p>
<pre><code>    C:\Program Files (x86)\Windows Kits\8.1\Lib\winv6.3\um\x86\
</code></pre>
<p>Recommend doing a quick test such as a hello world script to help you determine if your environment is ready to go or not:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb9-1"><a href="#cb9-1"></a></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co">-- hello_world.lua</span></span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="fu">print</span><span class="op">(</span><span class="st">&#39;hello world!&#39;</span><span class="op">)</span></span>
<span id="cb9-5"><a href="#cb9-5"></a></span></code></pre></div>
<pre><code>    [&gt; glue.exe srlua.exe hello_world.lua hello_world.exe
</code></pre>
<hr />
<h3 id="useful-learning-vim-links">Useful learning Vim links</h3>
<p><em>2017.08.23</em></p>
<ul>
<li><a href="https://youtu.be/XA2WjJbmmoM">Video: How to do 90% of what plugins do (with just Vim)</a></li>
<li><a href="https://vim-adventures.com">Game: Vim Adventures</a></li>
</ul>
<hr />
<h3 id="useful-wix-toolset-links">Useful WiX Toolset Links</h3>
<p><em>2017.08.19</em></p>
<p>The <a href="https://github.com/wixtoolset">WiX Toolset</a> is an open source set of tools to help in the creation of Windows Installers.</p>
<ul>
<li><a href="https://stackoverflow.com/questions/10741139/how-to-set-or-get-all-logs-in-a-custom-bootstrapper-application">How to get all logs associated with WiX</a></li>
<li><a href="https://stackoverflow.com/questions/15323427/cancel-installation-and-rollback-using-wix-burn-bootstrapper-ui">How to handle cancel and rollback in a custom Bootstrapper Application</a></li>
<li><a href="http://www.daves-blog.net/post/2014/08/29/Signing-WIX-Bottstrapper.aspx">When signing your WiX bootstrapper, remember to sign the WiX Engine as well</a></li>
<li><a href="https://stackoverflow.com/questions/320921/how-to-add-a-wix-custom-action-that-happens-only-on-uninstall-via-msi">Installer variable properties used in determining what install action is being performed</a></li>
<li><a href="https://stackoverflow.com/questions/18531272/how-do-i-distinguish-between-a-normal-install-and-an-upgrade-in-wix">Useful code for setting properties that define what install action is being performed</a></li>
<li><a href="https://stackoverflow.com/questions/11861573/upgradingproductcode-condition-not-working-in-wixui-install-wxs-in-library">UPGRADINGPRODUCTCODE is set only for the hidden uninstallation of a package</a></li>
</ul>
</body>
</html>
